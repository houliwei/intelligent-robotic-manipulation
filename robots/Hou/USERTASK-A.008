' TCP/IP  Server
' -----------------------------------------------------------
' 功能：从labview获取控制指令，并控制机器人运动



' -----------------------------------------------------------
*START
	FOR L1% = 1 TO 20 STEP 1	'初始化1-20#变量。 1：状态记录  2：接收  3：发送
		V$[L1%] = ""
		V![L1%] = 0
		V%[L1%] = 0
	NEXT



' -----------------------------------------------------------
*CREATE	
	V1$ = "sockcreat"
		SOCKCREATE 1,0    ' 1：套接字编号  0: TCP（0代表TCP，1代表UDP）
	IF E1%<0 Then *RESET



' -----------------------------------------------------------
*SOCKBIND	                   '分配端口
	V1$ = "sockbind"
		SOCKBIND 1,2000  ' 1：套接字编号   2000：端口编号
	IF E1%<0 Then *RESET



' -----------------------------------------------------------	
*SOCKWAIT	                   '等待客户端连接
	V1$ = "sockwait"
		SOCKWAIT 1,2,0    ' 1：等待连接套接字编号  2：通信套接字编号  0：持续等待连接，没有超时限制   
	IF E1%<0 Then *RESET


	
' -----------------------------------------------------------
*Connected
	V1$ = "Connect_OK"




' ****************************************************
*GET_DATA
	V1$ = "GET_DATA"
    SOCKRECV 2,1,0,5,V20%    '2:套接字编号 1：缓冲区编号 0：接收数据长度不限制（以字节为单位） 5：超时时间  v20%：将实际接收的数据大小写入 V20%
	GETSTR 1,V2$,0,V20%    '将存储于 1 号缓冲区数据开头V20%字节复制到字符串变量 V2$。
	V2% = VAL(V2$)
    IF V2%<>1 THEN *GET_DATA
	V2$ = ""
	V2% = 0


GETBYTE 1,V151%,0 
IF 13=V151% THEN *GET_DATA_END 
V10$ = V10$ + CHR$(V151%) 
GOTO *GET_DATA 
*GET_DATA_END

SOCKRECV 1,1,1,5,V100%
'代入移位寄存器
V160% = VAL(V10$) 
R1 = (0,V160%,0,0,0,0) 
‘ 
SOCKCLOSE 1 
EXIT


' -----------------------------------------------------------
*SOCKSEND，SOCKSENDSTR
' -----------------------------------------------------------
	V2! = 3.14
	SETREAL 2,V2!,0   '将存储于实数变量 V2!的值保存到 2 号缓冲区开头。(从指定的位置写入 4 字节的数据。)
	SOCKSEND 2,2,4,5,V19%  
	GOTO *GET_DATA




	
' -----------------------------------------------------------
*Closesock
' -----------------------------------------------------------
    SOCKCLOSE 1    ' 关闭1号套接字
    SOCKCLOSE 2	   ' 关闭2号套接字
    EXIT



' -----------------------------------------------------------
*RESET
' -----------------------------------------------------------
    V1$ = "套接字复位"	'套接字复位
	PRINT #0,STR$(E1%)
	PRINT #0,STR$(E2%)
	SOCKCLOSE 1
	SOCKCLOSE 2
	PAUSE 3000
	GOTO *START	



' -----------------------------------------------------------
*EXIT
' -----------------------------------------------------------
	EXIT






